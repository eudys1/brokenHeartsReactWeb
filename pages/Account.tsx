import Login from "../components/Login";
import Head from 'next/head'
import Header from "../components/Header";
import { useEffect, useState } from "react";
import Dashboard from "../components/Dashboard";
import {firebaseInit} from "../firebase";
import { getAuth, onAuthStateChanged } from "firebase/auth";
import { getFirestore, doc, getDoc } from "firebase/firestore";
import { User as FirebaseUser } from "firebase/auth";

const auth = getAuth(firebaseInit);
const firestore = getFirestore(firebaseInit);



export default function Account() {

    const [user, setUser] = useState<FirebaseUser | null>(null);

    //
    async function getFirestoreUserData(uid: any) {
        const docRef = doc(firestore, `usuarios/${uid}`);
        const docCifrada = await getDoc(docRef);
        const userInfo = docCifrada.data();

        return userInfo;
    }

    // 
    function setFirebaseUserWithNecesaryData(firebaseUser: any) {

        //
        getFirestoreUserData(firebaseUser.uid).then(userInfo => {

            if (!userInfo) return;
            
            const userData: any = {
                uid: firebaseUser.uid,
                email: firebaseUser.email,
                nombre: userInfo.nombre,
                apellidos: userInfo.apellidos,
                rol: userInfo.rol,
            };

            setUser(userData);

        });
    }

    //to control the login of the users
    useEffect(() => {
        onAuthStateChanged(auth, async (firebaseUser:any) =>  
        {(firebaseUser && !user ) ? (setFirebaseUserWithNecesaryData(firebaseUser)) : setUser(null); });


    }, []);

    // onAuthStateChanged(auth, async (firebaseUser: any) => {

    //     console.log('Me he actualizado')

    //     if (firebaseUser) {
    //         !user && setFirebaseUserWithNecesaryData(firebaseUser);

    //     } else {
    //         setUser(null);
    //     }
    // })

    // console.log("log final", user);


    return (
        <>
            <Head>
                <title>Broken Hearts</title>
                <meta name="Cuenta" content="Generated by Broken Hearts" />
                <link rel="icon" href="/favicon.ico" />
            </Head>

            <div className="bg-black">
                <Header className=' justify-between mx-32 mb-10' />
            </div>

            {user ? <Dashboard user={user} /> : <Login />}
            {/* <Login className="my-7" />
            <SigingUp /> */}

        </>
    )

}